<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="au theme template">
    <meta name="author" content="Hau Nguyen">
    <meta name="keywords" content="au theme template">
    <!-- Title Page-->
    <title>Charts</title>
    <!-- Fontfaces CSS-->
    <link href="css/font-face.css" rel="stylesheet" media="all">
    <link href="vendor/font-awesome-4.7/css/font-awesome.min.css" rel="stylesheet" media="all">
    <link href="vendor/font-awesome-5/css/fontawesome-all.min.css" rel="stylesheet" media="all">
    <link href="vendor/mdi-font/css/material-design-iconic-font.min.css" rel="stylesheet" media="all">
    <!-- Bootstrap CSS-->
    <link href="vendor/bootstrap-4.1/bootstrap.min.css" rel="stylesheet" media="all">
    <!-- Vendor CSS-->
    <link href="vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet" media="all">
    <link href="vendor/wow/animate.css" rel="stylesheet" media="all">
    <link href="vendor/css-hamburgers/hamburgers.min.css" rel="stylesheet" media="all">
    <link href="vendor/slick/slick.css" rel="stylesheet" media="all">
    <link href="vendor/select2/select2.min.css" rel="stylesheet" media="all">
    <link href="vendor/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet" media="all">
    <!-- Main CSS-->
    <link href="css/mytheme.css" rel="stylesheet" media="all">
    <!-- DynamoDB stuff -->
    <!--Set up the AWS SDK for JavaScript. To do this, add or modify the following script tag to your HTML pages: -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.279.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <script>
        function format_two_digits(n) {
            return n < 10 ? '0' + n : n;
        }

        function time_format(d) {
            hours = format_two_digits(d.getHours());
            minutes = format_two_digits(d.getMinutes());
            seconds = format_two_digits(d.getSeconds());
            return hours + ":" + minutes + ":" + seconds;
        }

        ////////////////
        // chart_func
        ////////////////

        function temperature_chart(x_label, y_label) {
            try {
                // temperature chart
                //document.getElementById('textarea').innerHTML +=  "y" + y_label + "\n";
                var tchart = document.getElementById("temp-chart");
                if (tchart) {
                    tchart.height = 150;
                    var myChart = new Chart(tchart, {
                        type: 'line',
                        data: {
                            labels: x_label,
                            type: 'line',
                            defaultFontFamily: 'Poppins',
                            datasets: [{
                                label: "Temperature",
                                data: y_label,
                                backgroundColor: 'transparent',
                                borderColor: 'rgba(220,53,69,0.75)',
                                borderWidth: 3,
                                pointStyle: 'circle',
                                pointRadius: 3,
                                pointBorderColor: 'transparent',
                                pointBackgroundColor: 'rgba(220,53,69,0.75)',
                            }]
                        },
                        options: {
                            responsive: true, tooltips: { mode: 'index', titleFontSize: 12, titleFontColor: '#000', bodyFontColor: '#000', backgroundColor: '#fff', titleFontFamily: 'Poppins', bodyFontFamily: 'Poppins', cornerRadius: 3, intersect: false, },
                            legend: { display: false, labels: { usePointStyle: true, fontFamily: 'Poppins', }, },
                            scales: {
                                xAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: false, labelString: 'Month' },
                                    ticks: { fontFamily: "Poppins" }
                                }],
                                yAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: true, labelString: 'Value', fontFamily: "Poppins" },
                                    ticks: { fontFamily: "Poppins" }
                                }]
                            },
                            title: { display: false, text: 'Normal Legend' }
                        }
                    });
                }

            } catch (error) {
                // document.getElementById('textarea').innerHTML += "chart error " + error + "\n";
            }
        }




        function humidity_chart(x_label, y_label) {
            try {
                // temperature chart
                //document.getElementById('textarea').innerHTML += "x " + x_label + "y" + y_label + "\n";
                var hchart = document.getElementById("hum-chart");
                if (hchart) {
                    hchart.height = 150;
                    var myChart = new Chart(hchart, {
                        type: 'line',
                        data: {
                            labels: x_label,
                            type: 'line',
                            defaultFontFamily: 'Poppins',
                            datasets: [{
                                label: "Humidity",
                                data: y_label,
                                backgroundColor: 'transparent',
                                borderColor: 'rgba(220,53,69,0.75)',
                                borderWidth: 3,
                                pointStyle: 'circle',
                                pointRadius: 3,
                                pointBorderColor: 'transparent',
                                pointBackgroundColor: 'rgba(220,53,69,0.75)',
                            }]
                        },
                        options: {
                            responsive: true, tooltips: { mode: 'index', titleFontSize: 12, titleFontColor: '#000', bodyFontColor: '#000', backgroundColor: '#fff', titleFontFamily: 'Poppins', bodyFontFamily: 'Poppins', cornerRadius: 3, intersect: false, },
                            legend: { display: false, labels: { usePointStyle: true, fontFamily: 'Poppins', }, },
                            scales: {
                                xAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: false, labelString: 'Month' },
                                    ticks: { fontFamily: "Poppins" }
                                }],
                                yAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: true, labelString: 'Value', fontFamily: "Poppins" },
                                    ticks: { fontFamily: "Poppins" }
                                }]
                            },
                            title: { display: false, text: 'Normal Legend' }
                        }
                    });
                }

            } catch (error) {
                //document.getElementById('textarea').innerHTML += "chart error " + error + "\n";
            }
        }





        function brightness_chart(x_label, y_label) {
            try {
                // temperature chart
                //document.getElementById('textarea').innerHTML += "x " + x_label + "y" + y_label + "\n";
                var bchart = document.getElementById("bright-chart");
                if (bchart) {
                    bchart.height = 150;
                    var myChart = new Chart(bchart, {
                        type: 'line',
                        data: {
                            labels: x_label,
                            type: 'line',
                            defaultFontFamily: 'Poppins',
                            datasets: [{
                                label: "brightness",
                                data: y_label,
                                backgroundColor: 'transparent',
                                borderColor: 'rgba(220,53,69,0.75)',
                                borderWidth: 3,
                                pointStyle: 'circle',
                                pointRadius: 3,
                                pointBorderColor: 'transparent',
                                pointBackgroundColor: 'rgba(220,53,69,0.75)',
                            }]
                        },
                        options: {
                            responsive: true, tooltips: { mode: 'index', titleFontSize: 12, titleFontColor: '#000', bodyFontColor: '#000', backgroundColor: '#fff', titleFontFamily: 'Poppins', bodyFontFamily: 'Poppins', cornerRadius: 3, intersect: false, },
                            legend: { display: false, labels: { usePointStyle: true, fontFamily: 'Poppins', }, },
                            scales: {
                                xAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: false, labelString: 'Month' },
                                    ticks: { fontFamily: "Poppins" }
                                }],
                                yAxes: [{
                                    display: true, gridLines: { display: false, drawBorder: false },
                                    scaleLabel: { display: true, labelString: 'Value', fontFamily: "Poppins" },
                                    ticks: { fontFamily: "Poppins" }
                                }]
                            },
                            title: { display: false, text: 'Normal Legend' }
                        }
                    });
                }

            } catch (error) {
                //document.getElementById('textarea').innerHTML += "chart error " + error + "\n";
            }
        }

        ////////////////
        // retrieve from table "lambda_data" all measure related to device "sensor"
        ////////////////

        //set connection //eu-west-1 //AKIAJXEXHT5WPWXJBJ2Q //UESvNVE1Q0pYAWtlSKMqjZbv9iGPPp+sE6L0+g0a //a2lzki3obz1dhu.iot.eu-west-1.amazonaws.com

        AWS.config.update({
            region: "<region>",
            endpoint: 'https://dynamodb.<region>.amazonaws.com',
            accessKeyId: "<access_key_id>",
            secretAccessKey: "<secret_access_key>"
        });

        var docClient = new AWS.DynamoDB.DocumentClient();

        function update_queryData(sensor) {

            //document.getElementById('textarea').innerHTML += " try query \n";
            starting_date = new Date(document.getElementById('selected_date').value)
            //document.getElementById('textarea').innerHTML += "starting_date: " + starting_date + "\n";
            ending_date = new Date(starting_date);
            ending_date.setDate(ending_date.getDate() + 1);
            //document.getElementById('textarea').innerHTML += "starting_date: " + starting_date + "\n";
            //document.getElementById('textarea').innerHTML += "ending_date: " + ending_date + "\n";
            start_date = starting_date.getTime() / 1000;
            end_date = ending_date.getTime() / 1000;
            //document.getElementById('textarea').innerHTML += "start_date: " + start_date + "\n";
            //document.getElementById('textarea').innerHTML += "end_date: " + end_date + "\n";

            // set table and query key attributes
            //IndexName : "device_id-timestamp",
            var params = {
                TableName: "<table_name>",
                // Index to query the table. Created with DynamoDB options
                IndexName: "device_id-timestamp-index",
                ProjectionExpression: "#id, iso_timestamp, sensor, #val, #st",
                KeyConditionExpression: "#id = :val AND #time_unix BETWEEN :day1 and :day2",
                //KeyConditionExpression: "#id = :val",
                ExpressionAttributeNames: {
                    "#id": "device_id",
                    "#val": "value",
                    "#st": "status",
                    "#time_unix": "timestamp"
                },
                ExpressionAttributeValues: {
                    ":val": sensor,
                    ":day1": start_date,
                    ":day2": end_date
                }
            };

            var temperature = []; var t_date = [];
            var humidity = []; var h_date = [];
            var brightness = []; var b_date = [];


            // retrieve data linked to the specified measure
            docClient.query(params, function (err, data) {
                if (err) {
                    //document.getElementById('textarea').innerHTML += "Unable to query. Error: " + "\n" + JSON.stringify(err, undefined, 2);
                } else {
                    //document.getElementById('textarea').innerHTML += "Querying for data from " + sensor + ": " + "\n" + JSON.stringify(data);

                    //document.getElementById('textarea').innerHTML += "data: " + data + "\n";
                    //document.getElementById('textarea').innerHTML += "data.Items: " + data.Items + "\n";
                    //document.getElementById('textarea').innerHTML += "data.iso_timestamp" + data.iso_timestamp + "\n";
                    //document.getElementById('textarea').innerHTML += "data.Items.length: " + data.Items.length + "\n";
                    for (i = 0, len = data.Items.length; i < len; ++i) {
                        //document.getElementById('textarea').innerHTML += "data.Items.iso_timestamp[i]" + data.Items[i].iso_timestamp + "\n";
                        if (data.Items[i].status == 'OK')
                            switch (data.Items[i].sensor) {
                                case 0:
                                    temperature.push(parseFloat(data.Items[i].value));
                                    t_date.push(time_format(new Date(data.Items[i].iso_timestamp)))
                                    break;
                                case 1:
                                    humidity.push(parseFloat(data.Items[i].value));
                                    h_date.push(time_format(new Date(data.Items[i].iso_timestamp)))
                                    break;
                                case 2:
                                    brightness.push(parseInt(data.Items[i].value));
                                    b_date.push(time_format(new Date(data.Items[i].iso_timestamp)))
                                    break;
                            }
                    }
                    temperature_chart(t_date, temperature);
                    humidity_chart(h_date, humidity);
                    brightness_chart(b_date, brightness);
                    //document.getElementById('textarea').innerHTML += "first done...";
                }
            });
        };

        // <textarea readonly id= "textarea" style="width:400px; height:800px"></textarea>
    </script>

</head>
<body>
    <div class="page-wrapper">
        <!-- PAGE CONTAINER-->
        <div class="page-container">
            <!-- HEADER DESKTOP-->
            <header class="header-desktop">

                <div class="header__logo">
                    <a class="logo">
                        <img src="images/icon/polito.png" alt="PoliTo" width="250px" />
                    </a>
                    <div>
                        <div class="header__navbar">
                            <ul class="list-unstyled navbar__list">
                                <li>
                                    <a href="chart.html"> <i class="fas fa-chart-bar"></i>Charts</a>
                                </li>
                                <li>
                                    <a href="table.html"> <i class="fas fa-table"></i>Tables</a>
                                </li>
                                <li>
                                    <a href="map.html"> <i class="fas fa-map-marker-alt"></i>Maps</a>
                                </li>
                                <ul>
                                    <div class="header__select">
                                        <select id="selected_board">
                                            <option value="FEZ26">FEZ26</option>
                                        </select>
                                    </div>
                                    <div class="header__select">
                                        <form>
                                            <label for="dt">Date: </label>
                                            <input id="selected_date" name="data" value="2018-07-24" type="date" min="2018-06" max="2018-08" />
                                        </form>
                                    </div>
                                    <div class="header__select">
                                        <input id="queryData" type="button" value="Update" onclick="update_queryData(document.getElementById('selected_board', 'selected_date').value);" />
                                    </div>
                        </div>
            </header>
            <!-- END HEADER DESKTOP-->
            <!-- MAIN CONTENT-->
            <div class="main-content">
                <div class="section__content ">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="au-card m-b-30">
                                    <div class="au-card-inner">
                                        <h3 class="title-2 m-b-40">Temperature</h3>
                                        <canvas id="temp-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="au-card m-b-30">
                                    <div class="au-card-inner">
                                        <h3 class="title-2 m-b-40">Humidity</h3>
                                        <canvas id="hum-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="au-card m-b-30">
                                    <div class="au-card-inner">
                                        <h3 class="title-2 m-b-40">Brightness</h3>
                                        <canvas id="bright-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END MAIN CONTENT-->
            </div>
            <!-- END PAGE CONTAINER-->
        </div>

        <!-- Jquery JS-->
        <script src="vendor/jquery-3.2.1.min.js"></script>
        <!-- Bootstrap JS-->
        <script src="vendor/bootstrap-4.1/popper.min.js"></script>
        <script src="vendor/bootstrap-4.1/bootstrap.min.js"></script>
        <!-- Vendor JS       -->
        <script src="vendor/slick/slick.min.js">
        </script>
        <script src="vendor/wow/wow.min.js"></script>
        <script src="vendor/animsition/animsition.min.js"></script>
        <script src="vendor/bootstrap-progressbar/bootstrap-progressbar.min.js">
        </script>
        <script src="vendor/counter-up/jquery.waypoints.min.js"></script>
        <script src="vendor/counter-up/jquery.counterup.min.js">
        </script>
        <script src="vendor/circle-progress/circle-progress.min.js"></script>
        <script src="vendor/perfect-scrollbar/perfect-scrollbar.js"></script>
        <script src="vendor/chartjs/Chart.bundle.min.js"></script>
        <script src="vendor/select2/select2.min.js">
        </script>
        <!-- Main JS-->
        <script src="js/main.js"></script>
</body>
</html>
<!-- end document-->
